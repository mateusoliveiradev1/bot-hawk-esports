import {
  SlashCommandBuilder,
  PermissionFlagsBits,
  ChannelType,
  TextChannel,
  Collection,
  Guild,
  Role,
  GuildChannel,
  CategoryChannel,
  ChatInputCommandInteraction,
  ColorResolvable,
  MessageFlags,
  EmbedBuilder,
  ActionRowBuilder,
  ButtonBuilder,
  ButtonStyle,
} from 'discord.js';
import { Command, CommandCategory } from '../../types/command';
import { ExtendedClient } from '../../types/client';
import { Logger } from '../../utils/logger';
import { HawkEmbedBuilder } from '../../utils/hawk-embed-builder';
import { HAWK_EMOJIS } from '../../constants/hawk-emojis';

/**
 * Clean old messages from channels
 */
async function cleanOldMessages(guild: Guild): Promise<string> {
  const logger = new Logger();
  let cleaned = 0;

  try {
    const channels = guild.channels.cache.filter(c => c.type === ChannelType.GuildText);

    for (const channel of Array.from(channels.values())) {
      if (!channel.isTextBased()) {
        continue;
      }

      try {
        const messages = await channel.messages.fetch({ limit: 100 });
        const oldMessages = messages.filter(
          msg => !msg.pinned && Date.now() - msg.createdTimestamp > 14 * 24 * 60 * 60 * 1000, // 14 dias
        );

        if (oldMessages.size > 0) {
          await channel.bulkDelete(oldMessages, true);
          cleaned += oldMessages.size;
        }
      } catch (error) {
        // Ignorar erros de canais espec√≠ficos (permiss√µes, mensagens muito antigas, etc.)
        logger.warn(`Could not clean messages in ${channel.name}:`, error);
      }
    }

    return `üßπ **Limpeza**: ${cleaned} mensagens antigas removidas`;
  } catch (error) {
    logger.error('Error cleaning messages:', error);
    return 'üßπ **Limpeza**: Erro na limpeza de mensagens';
  }
}

/**
 * Create progress embed with visual progress bar
 */
function createProgressEmbed(step: number, total: number, currentTask: string): any {
  const percentage = Math.round((step / total) * 100);
  const progressBar =
    '‚ñà'.repeat(Math.floor(percentage / 10)) + '‚ñë'.repeat(10 - Math.floor(percentage / 10));

  return HawkEmbedBuilder.createInfo(
    `${HAWK_EMOJIS.SYSTEM.ROCKET} Configurando Servidor Perfeito`,
    `**${currentTask}**\n\n${HAWK_EMOJIS.SYSTEM.LOADING} Progresso: ${percentage}%\n\`${progressBar}\` ${step}/${total}`,
    { footer: 'Criando a experi√™ncia Discord perfeita...' },
  );
}

/**
 * Bootstrap command - Automatically sets up the server with channels, roles, and content
 */
const bootstrap: Command = {
  data: new SlashCommandBuilder()
    .setName('bootstrap')
    .setDescription(`${HAWK_EMOJIS.SYSTEM.ROCKET} Configura automaticamente o servidor com canais, cargos e conte√∫dos`)
    .addStringOption(option =>
      option
        .setName('mode')
        .setDescription('Modo de configura√ß√£o')
        .setRequired(false)
        .addChoices(
          { name: `${HAWK_EMOJIS.SYSTEM.SETTINGS} Completo (Recomendado)`, value: 'full' },
          { name: `${HAWK_EMOJIS.SYSTEM.SETUP} Configura√ß√£o Inicial`, value: 'initial' },
          { name: `${HAWK_EMOJIS.SYSTEM.CHANNEL} Apenas Canais`, value: 'channels' },
          { name: `${HAWK_EMOJIS.USER} Apenas Cargos`, value: 'roles' },
          { name: `${HAWK_EMOJIS.SYSTEM.CONFIG} Apenas Configura√ß√µes`, value: 'config' },
        ),
    )
    .setDefaultMemberPermissions(PermissionFlagsBits.Administrator)
    .setDMPermission(false) as SlashCommandBuilder,

  category: CommandCategory.ADMIN,
  cooldown: 60,
  permissions: ['Administrator'],

  async execute(interaction: ChatInputCommandInteraction, client: ExtendedClient): Promise<void> {
    const logger = new Logger();
    const mode = (interaction.options?.get('mode')?.value as string) || 'full';

    if (!interaction.guild) {
      await interaction.reply({
        content: '‚ùå Este comando s√≥ pode ser usado em servidores!',
        flags: MessageFlags.Ephemeral,
      });
      return;
    }

    try {
      await interaction.deferReply({ flags: MessageFlags.Ephemeral });

      const guild = interaction.guild;
      const setupResults: string[] = [];

      // Fun√ß√£o para executar o bootstrap
      const performBootstrap = async () => {
        const totalSteps = mode === 'full' ? 7 : mode === 'initial' ? 4 : 3;
        let currentStep = 0;

        const updateProgress = async (task: string) => {
          currentStep++;
          const progressEmbed = createProgressEmbed(currentStep, totalSteps, task);
          await interaction.editReply({ embeds: [progressEmbed] });
        };

        try {
          if (mode === 'full' || mode === 'initial') {
            await updateProgress('üßπ Limpando mensagens antigas...');
            setupResults.push(await cleanOldMessages(guild));
          }

          if (mode === 'full' || mode === 'roles') {
            await updateProgress('üë• Configurando cargos...');
            setupResults.push(await setupRoles(guild));
          }

          if (mode === 'full' || mode === 'channels') {
            await updateProgress('üìÅ Criando canais...');
            setupResults.push(await setupChannels(guild, mode));
          }

          if (mode === 'full') {
            await updateProgress('üóÑÔ∏è Configurando banco de dados...');
            setupResults.push(await setupDatabase(guild, client));

            await updateProgress('üîê Configurando permiss√µes...');
            setupResults.push(await setupPermissions(guild));

            await updateProgress('üéØ Configurando elementos interativos...');
            await setupInteractiveElements(guild);
            await setupAutomaticReactions(guild);

            await updateProgress('‚ú® Finalizando configura√ß√£o...');
            setupResults.push(await setupWelcomeMessages(guild));
            setupResults.push(await setupFinalTouches(guild));
          }

          // Embed de sucesso
          const successEmbed = new EmbedBuilder()
            .setTitle('‚úÖ Configura√ß√£o Conclu√≠da!')
            .setDescription('O servidor foi configurado com sucesso!')
            .setColor(0x00ff00)
            .addFields(
              { name: 'üìä Resumo', value: setupResults.join('\n'), inline: false },
              { name: '‚è∞ Tempo', value: `<t:${Math.floor(Date.now() / 1000)}:R>`, inline: true },
              { name: 'üîß Modo', value: mode, inline: true },
            )
            .setFooter({ text: 'Hawk Esports Bot - Sistema de Configura√ß√£o' })
            .setTimestamp();

          await interaction.editReply({ embeds: [successEmbed] });
        } catch (error) {
          logger.error('Bootstrap error:', error);
          const errorEmbed = new EmbedBuilder()
            .setTitle('‚ùå Erro na Configura√ß√£o')
            .setDescription(`Ocorreu um erro durante a configura√ß√£o: ${error}`)
            .setColor(0xff0000)
            .setTimestamp();

          await interaction.editReply({ embeds: [errorEmbed] });
        }
      };

      // Verificar se j√° foi configurado
      let existingConfig;
      try {
        existingConfig = await client.database.client.guildConfig.findUnique({
          where: { guildId: guild.id },
        });
      } catch (error) {
        logger.warn('Could not check existing config:', error);
      }

      const configData = existingConfig?.config as any;
      if (configData?.isSetup && mode === 'full') {
        const confirmEmbed = new EmbedBuilder()
          .setTitle('‚ö†Ô∏è Servidor j√° configurado')
          .setDescription('Este servidor j√° foi configurado anteriormente. Deseja reconfigurar?')
          .setColor(0xffa500)
          .addFields(
            {
              name: 'üìÖ Configurado em',
              value: existingConfig
                ? `<t:${Math.floor(existingConfig.createdAt.getTime() / 1000)}:F>`
                : 'N√£o dispon√≠vel',
              inline: true,
            },
            {
              name: 'üîß √öltima atualiza√ß√£o',
              value: existingConfig
                ? `<t:${Math.floor(existingConfig.updatedAt.getTime() / 1000)}:R>`
                : 'N√£o dispon√≠vel',
              inline: true,
            },
          );

        const confirmRow = new ActionRowBuilder<ButtonBuilder>().addComponents(
          new ButtonBuilder()
            .setCustomId('bootstrap_confirm')
            .setLabel('Sim, reconfigurar')
            .setStyle(ButtonStyle.Danger)
            .setEmoji('üîÑ'),
          new ButtonBuilder()
            .setCustomId('bootstrap_cancel')
            .setLabel('Cancelar')
            .setStyle(ButtonStyle.Secondary)
            .setEmoji('‚ùå'),
        );

        const response = await interaction.editReply({
          embeds: [confirmEmbed],
          components: [confirmRow],
        });

        try {
          const confirmation = await response.awaitMessageComponent({
            filter: i => i.user.id === interaction.user.id,
            time: 30000,
          });

          if (confirmation.customId === 'bootstrap_cancel') {
            await confirmation.update({
              embeds: [new EmbedBuilder().setTitle('‚ùå Configura√ß√£o cancelada').setColor(0xff0000)],
              components: [],
            });
            return;
          }

          if (confirmation.customId === 'bootstrap_confirm') {
            await confirmation.update({
              embeds: [
                new EmbedBuilder().setTitle('üîÑ Reconfigurando servidor...').setColor(0x0099ff),
              ],
              components: [],
            });

            // Continuar com a configura√ß√£o
            await performBootstrap();
          }
        } catch (error) {
          logger.warn('Confirmation timeout or error:', error);
          await interaction.editReply({
            embeds: [new EmbedBuilder().setTitle('‚è∞ Tempo esgotado').setColor(0xff0000)],
            components: [],
          });
          return;
        }

        return;
      }

      await performBootstrap();
    } catch (error) {
      logger.error('Bootstrap command error:', error);

      const errorEmbed = new EmbedBuilder()
        .setTitle('‚ùå Erro na configura√ß√£o')
        .setDescription(
          'Ocorreu um erro durante a configura√ß√£o do servidor. Verifique as permiss√µes do bot.',
        )
        .setColor(0xff0000)
        .addFields({
          name: 'üîç Detalhes',
          value: error instanceof Error ? error.message.slice(0, 1000) : 'Erro desconhecido',
        });

      if (interaction.deferred || interaction.replied) {
        await interaction.editReply({ embeds: [errorEmbed] });
      } else {
        await interaction.reply({ embeds: [errorEmbed], flags: MessageFlags.Ephemeral });
      }
    }
  },
};

/**
 * Setup server roles
 */
async function setupRoles(guild: Guild): Promise<string> {
  const logger = new Logger();
  let created = 0;
  let updated = 0;

  // Staff Roles (Highest Priority)
  const staffRoles = [
    { name: 'üëë Fundador', color: 0xffd700, position: 50, permissions: ['ADMINISTRATOR'] },
    {
      name: 'üõ°Ô∏è Admin',
      color: 0xe74c3c,
      position: 49,
      permissions: ['MANAGE_GUILD', 'MANAGE_CHANNELS', 'MANAGE_ROLES'],
    },
    {
      name: '‚öîÔ∏è Moderador',
      color: 0x3498db,
      position: 48,
      permissions: ['MANAGE_MESSAGES', 'KICK_MEMBERS', 'MUTE_MEMBERS'],
    },
    { name: 'üéØ Helper', color: 0x2ecc71, position: 47, permissions: ['MANAGE_MESSAGES'] },
    { name: 'ü§ñ Bot Manager', color: 0x7289da, position: 46, permissions: ['MANAGE_WEBHOOKS'] },
  ];

  // VIP & Special Roles
  const vipRoles = [
    { name: 'üíé VIP Diamond', color: 0xb9f2ff, position: 45 },
    { name: 'üåü VIP Gold', color: 0xffd700, position: 44 },
    { name: '‚≠ê VIP Silver', color: 0xc0c0c0, position: 43 },
    { name: 'üéµ DJ Oficial', color: 0x1abc9c, position: 42 },
    { name: 'üé® Designer', color: 0xe67e22, position: 41 },
    { name: 'üìπ Streamer', color: 0x9146ff, position: 40 },
    { name: 'üé¨ Content Creator', color: 0xff69b4, position: 39 },
  ];

  // Achievement Roles
  const achievementRoles = [
    { name: 'üèÜ Campe√£o', color: 0xffd700, position: 38 },
    { name: 'ü•á MVP da Temporada', color: 0xf39c12, position: 37 },
    { name: 'üéØ Sniper Elite', color: 0xff6b6b, position: 36 },
    { name: 'üî• Clutch Master', color: 0xff4500, position: 35 },
    { name: 'üëë Chicken Dinner King', color: 0xffa500, position: 34 },
    { name: 'üéñÔ∏è Veterano', color: 0x8b4513, position: 33 },
  ];

  // PUBG Competitive Ranks
  const pubgCompetitiveRanks = [
    { name: 'üèÜ Conqueror', color: 0x9c27b0, position: 32 },
    { name: 'üíé Grandmaster', color: 0xff1744, position: 31 },
    { name: 'üî• Master', color: 0xff6b6b, position: 30 },
    { name: 'üí† Diamond', color: 0xb9f2ff, position: 29 },
    { name: 'ü•à Platinum', color: 0xe5e4e2, position: 28 },
    { name: 'ü•á Gold', color: 0xffd700, position: 27 },
    { name: 'ü•â Silver', color: 0xc0c0c0, position: 26 },
    { name: 'üü§ Bronze', color: 0xcd7f32, position: 25 },
  ];

  // Activity & Engagement Roles
  const activityRoles = [
    { name: 'üî• Ativo', color: 0xff4500, position: 24 },
    { name: 'üí¨ Conversador', color: 0x00ced1, position: 23 },
    { name: 'üéÆ Gamer Dedicado', color: 0x32cd32, position: 22 },
    { name: 'üéâ Animador', color: 0xff69b4, position: 21 },
    { name: 'ü§ù Colaborativo', color: 0x20b2aa, position: 20 },
  ];

  // Squad & Team Roles
  const squadRoles = [
    { name: 'üéØ IGL (In-Game Leader)', color: 0xff6347, position: 19 },
    { name: 'üî´ Fragger', color: 0xdc143c, position: 18 },
    { name: 'üõ°Ô∏è Support', color: 0x4169e1, position: 17 },
    { name: 'üéØ Sniper', color: 0x8b008b, position: 16 },
    { name: 'üèÉ Entry Fragger', color: 0xff8c00, position: 15 },
  ];

  // Game Mode Preferences
  const gameModeRoles = [
    { name: 'üë§ Solo Player', color: 0x708090, position: 14 },
    { name: 'üë• Duo Player', color: 0x4682b4, position: 13 },
    { name: 'üéÆ Squad Player', color: 0x228b22, position: 12 },
    { name: 'üì± Mobile Player', color: 0xff1493, position: 11 },
    { name: 'üíª PC Player', color: 0x6495ed, position: 10 },
  ];

  // Notification Roles
  const notificationRoles = [
    { name: 'üîî Eventos', color: 0xffa500, position: 9 },
    { name: 'üèÜ Torneios', color: 0xffd700, position: 8 },
    { name: 'üéâ An√∫ncios', color: 0xff69b4, position: 7 },
    { name: 'üéµ M√∫sica', color: 0x9370db, position: 6 },
    { name: 'üé¨ Streams', color: 0x9146ff, position: 5 },
  ];

  // Basic Member Roles
  const basicRoles = [
    { name: '‚úÖ Verificado', color: 0x2ecc71, position: 4 },
    { name: 'üå± Iniciante', color: 0x95a5a6, position: 3 },
    { name: 'üëã Novo Membro', color: 0xbdc3c7, position: 2 },
  ];

  // Combine all roles
  const roles = [
    ...staffRoles,
    ...vipRoles,
    ...achievementRoles,
    ...pubgCompetitiveRanks,
    ...activityRoles,
    ...squadRoles,
    ...gameModeRoles,
    ...notificationRoles,
    ...basicRoles,
  ];

  for (const roleData of roles) {
    try {
      const existingRole = guild.roles.cache.find((r: any) => r.name === roleData.name);

      if (existingRole) {
        await existingRole.edit({
          color: roleData.color,
          position: roleData.position,
        });
        updated++;
      } else {
        await guild.roles.create({
          name: roleData.name,
          color: roleData.color,
          position: roleData.position,
          mentionable: false,
        });
        created++;
      }
    } catch (error) {
      logger.error(`Error creating/updating role ${roleData.name}:`, error);
    }
  }

  return `üé≠ **Cargos**: ${created} criados, ${updated} atualizados`;
}

// Interface for channel configuration
interface ChannelConfig {
  name: string;
  type: ChannelType;
  category?: string;
  topic?: string;
  position?: number;
  userLimit?: number;
}

/**
 * Setup server channels
 */
async function setupChannels(guild: Guild, mode: string = 'full'): Promise<string> {
  const logger = new Logger();
  let created = 0;
  let updated = 0;

  // Define canais essenciais para configura√ß√£o inicial
  const essentialChannels: ChannelConfig[] = [
    // Categories
    { name: 'üìã INFORMA√á√ïES', type: ChannelType.GuildCategory, position: 0 },
    { name: 'üí¨ CHAT GERAL', type: ChannelType.GuildCategory, position: 1 },
    { name: 'ü§ù COMUNIDADE', type: ChannelType.GuildCategory, position: 2 },
    { name: 'üé´ TICKETS', type: ChannelType.GuildCategory, position: 3 },
    { name: 'üîß ADMINISTRA√á√ÉO', type: ChannelType.GuildCategory, position: 4 },

    // Essential information channels
    {
      name: 'üìú-regras',
      type: ChannelType.GuildText,
      category: 'üìã INFORMA√á√ïES',
      topic: 'üìã Leia as regras do servidor antes de participar das atividades',
    },
    {
      name: 'üì¢-an√∫ncios',
      type: ChannelType.GuildText,
      category: 'üìã INFORMA√á√ïES',
      topic: 'üì¢ An√∫ncios importantes e atualiza√ß√µes do servidor',
    },
    {
      name: 'üëã-boas-vindas',
      type: ChannelType.GuildText,
      category: 'üí¨ CHAT GERAL',
      topic: 'üëã Canal de boas-vindas para novos membros',
    },

    // Essential general chat
    {
      name: 'üí¨-geral',
      type: ChannelType.GuildText,
      category: 'üí¨ CHAT GERAL',
      topic: 'üí¨ Conversa geral da comunidade',
    },
    {
      name: 'ü§ñ-comandos',
      type: ChannelType.GuildText,
      category: 'üí¨ CHAT GERAL',
      topic: 'ü§ñ Use os comandos do bot aqui para n√£o poluir outros canais',
    },

    // Essential community and tickets
    {
      name: 'üéüÔ∏è-abrir-ticket',
      type: ChannelType.GuildText,
      category: 'ü§ù COMUNIDADE',
      topic: 'üéüÔ∏è Canal p√∫blico para abrir tickets de suporte - Use os bot√µes abaixo!',
    },

    // Essential administration
    {
      name: 'üìù-logs-geral',
      type: ChannelType.GuildText,
      category: 'üîß ADMINISTRA√á√ÉO',
      topic: 'üìù Logs gerais do servidor: entradas, sa√≠das e atividades importantes',
    },
    {
      name: 'üé´-logs-ticket',
      type: ChannelType.GuildText,
      category: 'üîß ADMINISTRA√á√ÉO',
      topic: 'üé´ Logs espec√≠ficos do sistema de tickets',
    },
  ];

  // Define todos os canais para configura√ß√£o completa
  const allChannels: ChannelConfig[] = [
    // Categories
    { name: 'üìã INFORMA√á√ïES', type: ChannelType.GuildCategory, position: 0 },
    { name: 'üí¨ CHAT GERAL', type: ChannelType.GuildCategory, position: 1 },
    { name: 'üéÆ PUBG COMPETITIVO', type: ChannelType.GuildCategory, position: 2 },
    { name: 'üéØ PUBG CASUAL', type: ChannelType.GuildCategory, position: 3 },
    { name: 'üéµ M√öSICA & ENTRETENIMENTO', type: ChannelType.GuildCategory, position: 4 },
    { name: 'üé≤ JOGOS & ATIVIDADES', type: ChannelType.GuildCategory, position: 5 },
    { name: 'üé¨ CONTE√öDO & M√çDIA', type: ChannelType.GuildCategory, position: 6 },
    { name: 'üèÜ COMPETI√á√ïES & EVENTOS', type: ChannelType.GuildCategory, position: 7 },
    { name: 'ü§ù COMUNIDADE', type: ChannelType.GuildCategory, position: 8 },
    { name: 'üé´ TICKETS', type: ChannelType.GuildCategory, position: 9 },
    { name: 'üîß ADMINISTRA√á√ÉO', type: ChannelType.GuildCategory, position: 10 },

    // Information channels
    {
      name: 'üìú-regras',
      type: ChannelType.GuildText,
      category: 'üìã INFORMA√á√ïES',
      topic: 'üìã Leia as regras do servidor antes de participar das atividades',
    },
    {
      name: 'üì¢-an√∫ncios',
      type: ChannelType.GuildText,
      category: 'üìã INFORMA√á√ïES',
      topic: 'üì¢ An√∫ncios importantes e atualiza√ß√µes do servidor',
    },
    {
      name: 'üéâ-eventos',
      type: ChannelType.GuildText,
      category: 'üìã INFORMA√á√ïES',
      topic: 'üéâ Eventos especiais e competi√ß√µes da comunidade',
    },
    {
      name: 'üìä-rankings-geral',
      type: ChannelType.GuildText,
      category: 'üìã INFORMA√á√ïES',
      topic: 'üìä Rankings gerais e estat√≠sticas globais do servidor',
    },
    {
      name: 'üìã-changelog',
      type: ChannelType.GuildText,
      category: 'üìã INFORMA√á√ïES',
      topic: 'üìã Atualiza√ß√µes do bot, novidades e mudan√ßas no servidor',
    },

    // General chat
    {
      name: 'üí¨-geral',
      type: ChannelType.GuildText,
      category: 'üí¨ CHAT GERAL',
      topic: 'üí¨ Conversa geral da comunidade',
    },
    {
      name: 'ü§ñ-comandos',
      type: ChannelType.GuildText,
      category: 'üí¨ CHAT GERAL',
      topic: 'ü§ñ Use os comandos do bot aqui para n√£o poluir outros canais',
    },
    {
      name: 'üëã-boas-vindas',
      type: ChannelType.GuildText,
      category: 'üí¨ CHAT GERAL',
      topic: 'üëã Canal de boas-vindas para novos membros',
    },
    {
      name: 'üé≠-off-topic',
      type: ChannelType.GuildText,
      category: 'üí¨ CHAT GERAL',
      topic: 'üé≠ Conversas aleat√≥rias, memes e assuntos diversos',
    },
    {
      name: 'üîó-links-√∫teis',
      type: ChannelType.GuildText,
      category: 'üí¨ CHAT GERAL',
      topic: 'üîó Links √∫teis, recursos e ferramentas para PUBG',
    },

    // PUBG Competitive channels
    {
      name: 'üèÜ-ranking-competitivo',
      type: ChannelType.GuildText,
      category: 'üéÆ PUBG COMPETITIVO',
      topic: 'üèÜ Rankings oficiais, temporadas e competi√ß√µes do servidor',
    },
    {
      name: 'üéØ-scrims',
      type: ChannelType.GuildText,
      category: 'üéÆ PUBG COMPETITIVO',
      topic: 'üéØ Organize e participe de scrimmages e treinos competitivos',
    },
    {
      name: 'üìà-stats-pro',
      type: ChannelType.GuildText,
      category: 'üéÆ PUBG COMPETITIVO',
      topic: 'üìà Estat√≠sticas avan√ßadas, an√°lises e progresso competitivo',
    },
    {
      name: 'üéÆ-estrat√©gias',
      type: ChannelType.GuildText,
      category: 'üéÆ PUBG COMPETITIVO',
      topic: 'üéÆ Discuss√µes sobre estrat√©gias, t√°ticas e meta do jogo',
    },
    {
      name: 'üî•-highlights-pro',
      type: ChannelType.GuildText,
      category: 'üéÆ PUBG COMPETITIVO',
      topic: 'üî• Melhores jogadas competitivas e momentos √©picos',
    },

    // PUBG Casual channels
    {
      name: 'üéÆ-pubg-geral',
      type: ChannelType.GuildText,
      category: 'üéØ PUBG CASUAL',
      topic: 'üéÆ Discuss√µes gerais sobre PUBG, dicas e novidades do jogo',
    },
    {
      name: 'üë•-procurar-squad',
      type: ChannelType.GuildText,
      category: 'üéØ PUBG CASUAL',
      topic: 'üë• Encontre parceiros para jogar, forme squads e organize partidas',
    },
    {
      name: 'üì±-pubg-mobile',
      type: ChannelType.GuildText,
      category: 'üéØ PUBG CASUAL',
      topic: 'üì± Discuss√µes espec√≠ficas sobre PUBG Mobile',
    },
    {
      name: 'üé™-partidas-custom',
      type: ChannelType.GuildText,
      category: 'üéØ PUBG CASUAL',
      topic: 'üé™ Organize partidas customizadas e eventos casuais',
    },
    {
      name: 'üì∏-screenshots',
      type: ChannelType.GuildText,
      category: 'üéØ PUBG CASUAL',
      topic: 'üì∏ Compartilhe screenshots, skins e momentos do jogo',
    },

    // Music & Entertainment channels
    {
      name: 'üéµ-m√∫sica',
      type: ChannelType.GuildText,
      category: 'üéµ M√öSICA & ENTRETENIMENTO',
      topic: 'üéµ Comandos de m√∫sica, pedidos de m√∫sicas e controle do bot',
    },
    {
      name: 'üéß-queue',
      type: ChannelType.GuildText,
      category: 'üéµ M√öSICA & ENTRETENIMENTO',
      topic: 'üéß Visualize a fila de reprodu√ß√£o atual e pr√≥ximas m√∫sicas',
    },
    {
      name: 'üé§-karaok√™',
      type: ChannelType.GuildText,
      category: 'üéµ M√öSICA & ENTRETENIMENTO',
      topic: 'üé§ Organize sess√µes de karaok√™ e cante junto',
    },
    {
      name: 'üé¨-filmes-s√©ries',
      type: ChannelType.GuildText,
      category: 'üéµ M√öSICA & ENTRETENIMENTO',
      topic: 'üé¨ Discuss√µes sobre filmes, s√©ries e entretenimento',
    },
    {
      name: 'üì∫-watch-party',
      type: ChannelType.GuildText,
      category: 'üéµ M√öSICA & ENTRETENIMENTO',
      topic: 'üì∫ Organize sess√µes para assistir conte√∫do juntos',
    },

    // Games & Activities
    {
      name: 'üéØ-mini-games',
      type: ChannelType.GuildText,
      category: 'üé≤ JOGOS & ATIVIDADES',
      topic: 'üéØ Mini-games divertidos e desafios r√°pidos da comunidade',
    },
    {
      name: 'üß†-quizzes',
      type: ChannelType.GuildText,
      category: 'üé≤ JOGOS & ATIVIDADES',
      topic: 'üß† Quizzes sobre PUBG, jogos em geral e conhecimentos diversos',
    },
    {
      name: 'üèÖ-desafios',
      type: ChannelType.GuildText,
      category: 'üé≤ JOGOS & ATIVIDADES',
      topic: 'üèÖ Desafios especiais, miss√µes da comunidade e competi√ß√µes tem√°ticas',
    },
    {
      name: 'üéñÔ∏è-badges',
      type: ChannelType.GuildText,
      category: 'üé≤ JOGOS & ATIVIDADES',
      topic: 'üéñÔ∏è Sistema de conquistas, badges especiais e recompensas',
    },
    {
      name: 'üé≤-outros-jogos',
      type: ChannelType.GuildText,
      category: 'üé≤ JOGOS & ATIVIDADES',
      topic: 'üé≤ Discuss√µes sobre outros jogos al√©m do PUBG',
    },
    {
      name: 'üÉè-jogos-de-mesa',
      type: ChannelType.GuildText,
      category: 'üé≤ JOGOS & ATIVIDADES',
      topic: 'üÉè Jogos de mesa online, cartas e atividades em grupo',
    },

    // Content & Media
    {
      name: 'üé¨-clips',
      type: ChannelType.GuildText,
      category: 'üé¨ CONTE√öDO & M√çDIA',
      topic: 'üé¨ Compartilhe seus melhores clips e jogadas √©picas',
    },
    {
      name: '‚≠ê-highlights',
      type: ChannelType.GuildText,
      category: 'üé¨ CONTE√öDO & M√çDIA',
      topic: '‚≠ê Os melhores highlights da comunidade selecionados',
    },
    {
      name: 'üìä-clip-rankings',
      type: ChannelType.GuildText,
      category: 'üé¨ CONTE√öDO & M√çDIA',
      topic: 'üìä Rankings dos melhores clips e vota√ß√µes da comunidade',
    },
    {
      name: 'üìπ-streams',
      type: ChannelType.GuildText,
      category: 'üé¨ CONTE√öDO & M√çDIA',
      topic: 'üìπ Divulgue suas lives e acompanhe streamers da comunidade',
    },
    {
      name: 'üé®-arte-criativa',
      type: ChannelType.GuildText,
      category: 'üé¨ CONTE√öDO & M√çDIA',
      topic: 'üé® Arte, designs, wallpapers e cria√ß√µes da comunidade',
    },
    {
      name: 'üìù-conte√∫do-escrito',
      type: ChannelType.GuildText,
      category: 'üé¨ CONTE√öDO & M√çDIA',
      topic: 'üìù Guias, tutoriais, an√°lises e conte√∫do escrito',
    },

    // Competitions & Events
    {
      name: 'üèÜ-torneios',
      type: ChannelType.GuildText,
      category: 'üèÜ COMPETI√á√ïES & EVENTOS',
      topic: 'üèÜ Torneios oficiais, inscri√ß√µes e resultados',
    },
    {
      name: 'üé™-eventos-especiais',
      type: ChannelType.GuildText,
      category: 'üèÜ COMPETI√á√ïES & EVENTOS',
      topic: 'üé™ Eventos tem√°ticos, celebra√ß√µes e atividades especiais',
    },
    {
      name: 'ü•á-hall-da-fama',
      type: ChannelType.GuildText,
      category: 'üèÜ COMPETI√á√ïES & EVENTOS',
      topic: 'ü•á Campe√µes, recordes e conquistas memor√°veis',
    },
    {
      name: 'üìÖ-calend√°rio',
      type: ChannelType.GuildText,
      category: 'üèÜ COMPETI√á√ïES & EVENTOS',
      topic: 'üìÖ Cronograma de eventos, torneios e atividades programadas',
    },
    {
      name: 'üéÅ-premia√ß√µes',
      type: ChannelType.GuildText,
      category: 'üèÜ COMPETI√á√ïES & EVENTOS',
      topic: 'üéÅ Sistema de recompensas, pr√™mios e sorteios',
    },

    // Community
    {
      name: 'üí°-sugest√µes',
      type: ChannelType.GuildText,
      category: 'ü§ù COMUNIDADE',
      topic: 'üí° Sugest√µes para melhorar o servidor e a comunidade',
    },
    {
      name: 'üÜò-suporte',
      type: ChannelType.GuildText,
      category: 'ü§ù COMUNIDADE',
      topic: 'üÜò Tire d√∫vidas e receba ajuda da comunidade',
    },
    {
      name: 'ü§ù-parcerias',
      type: ChannelType.GuildText,
      category: 'ü§ù COMUNIDADE',
      topic: 'ü§ù Propostas de parcerias e colabora√ß√µes',
    },
    {
      name: 'üì¢-divulga√ß√£o',
      type: ChannelType.GuildText,
      category: 'ü§ù COMUNIDADE',
      topic: 'üì¢ Divulgue seu conte√∫do, canal ou servidor (com modera√ß√£o)',
    },
    {
      name: 'üéÇ-anivers√°rios',
      type: ChannelType.GuildText,
      category: 'ü§ù COMUNIDADE',
      topic: 'üéÇ Comemore anivers√°rios e datas especiais dos membros',
    },
    {
      name: 'üí¨-feedback',
      type: ChannelType.GuildText,
      category: 'ü§ù COMUNIDADE',
      topic: 'üí¨ Feedback sobre o servidor, bot e experi√™ncia geral',
    },

    // Administration
    {
      name: 'üîß-admin-geral',
      type: ChannelType.GuildText,
      category: 'üîß ADMINISTRA√á√ÉO',
      topic: 'üîß Canal geral da administra√ß√£o para discuss√µes internas',
    },
    {
      name: 'üìù-logs-geral',
      type: ChannelType.GuildText,
      category: 'üîß ADMINISTRA√á√ÉO',
      topic: 'üìù Logs gerais do servidor: entradas, sa√≠das e atividades importantes',
    },
    {
      name: 'üé´-logs-ticket',
      type: ChannelType.GuildText,
      category: 'üîß ADMINISTRA√á√ÉO',
      topic: 'üé´ Logs espec√≠ficos do sistema de tickets',
    },
    {
      name: '‚ùå-logs-erro',
      type: ChannelType.GuildText,
      category: 'üîß ADMINISTRA√á√ÉO',
      topic: '‚ùå Logs de erros e problemas t√©cnicos do bot',
    },
    {
      name: 'üîí-logs-seguranca',
      type: ChannelType.GuildText,
      category: 'üîß ADMINISTRA√á√ÉO',
      topic: 'üîí Logs de seguran√ßa, modera√ß√£o e a√ß√µes administrativas',
    },
    {
      name: 'üåê-logs-api',
      type: ChannelType.GuildText,
      category: 'üîß ADMINISTRA√á√ÉO',
      topic: 'üåê Logs de integra√ß√µes com APIs externas (PUBG, etc.)',
    },
    {
      name: 'üéüÔ∏è-abrir-ticket',
      type: ChannelType.GuildText,
      category: 'ü§ù COMUNIDADE',
      topic: 'üéüÔ∏è Canal p√∫blico para abrir tickets de suporte - Use os bot√µes abaixo!',
    },

    // Voice channels - General
    {
      name: 'üîä Lobby Geral',
      type: ChannelType.GuildVoice,
      category: 'üí¨ CHAT GERAL',
      userLimit: 15,
    },
    {
      name: 'üí¨ Conversa Livre',
      type: ChannelType.GuildVoice,
      category: 'üí¨ CHAT GERAL',
      userLimit: 10,
    },
    {
      name: 'üé≠ Sala Privada 1',
      type: ChannelType.GuildVoice,
      category: 'üí¨ CHAT GERAL',
      userLimit: 5,
    },
    {
      name: 'üé≠ Sala Privada 2',
      type: ChannelType.GuildVoice,
      category: 'üí¨ CHAT GERAL',
      userLimit: 5,
    },

    // Voice channels - PUBG Competitive
    {
      name: 'üèÜ Scrimmage',
      type: ChannelType.GuildVoice,
      category: 'üéÆ PUBG COMPETITIVO',
      userLimit: 4,
    },
    {
      name: 'üéØ Treino Competitivo',
      type: ChannelType.GuildVoice,
      category: 'üéÆ PUBG COMPETITIVO',
      userLimit: 4,
    },
    {
      name: 'üìä An√°lise T√°tica',
      type: ChannelType.GuildVoice,
      category: 'üéÆ PUBG COMPETITIVO',
      userLimit: 8,
    },
    {
      name: 'üî• Squad Pro 1',
      type: ChannelType.GuildVoice,
      category: 'üéÆ PUBG COMPETITIVO',
      userLimit: 4,
    },
    {
      name: 'üî• Squad Pro 2',
      type: ChannelType.GuildVoice,
      category: 'üéÆ PUBG COMPETITIVO',
      userLimit: 4,
    },

    // Voice channels - PUBG Casual
    {
      name: 'üéÆ Squad Casual 1',
      type: ChannelType.GuildVoice,
      category: 'üéØ PUBG CASUAL',
      userLimit: 4,
    },
    {
      name: 'üéÆ Squad Casual 2',
      type: ChannelType.GuildVoice,
      category: 'üéØ PUBG CASUAL',
      userLimit: 4,
    },
    {
      name: 'üéÆ Squad Casual 3',
      type: ChannelType.GuildVoice,
      category: 'üéØ PUBG CASUAL',
      userLimit: 4,
    },
    {
      name: 'üéÆ Squad Casual 4',
      type: ChannelType.GuildVoice,
      category: 'üéØ PUBG CASUAL',
      userLimit: 4,
    },
    {
      name: 'üì± PUBG Mobile',
      type: ChannelType.GuildVoice,
      category: 'üéØ PUBG CASUAL',
      userLimit: 6,
    },
    {
      name: 'üé™ Partidas Custom',
      type: ChannelType.GuildVoice,
      category: 'üéØ PUBG CASUAL',
      userLimit: 10,
    },

    // Voice channels - Music & Entertainment
    {
      name: 'üéµ M√∫sica Principal',
      type: ChannelType.GuildVoice,
      category: 'üéµ M√öSICA & ENTRETENIMENTO',
      userLimit: 20,
    },
    {
      name: 'üé§ Karaok√™',
      type: ChannelType.GuildVoice,
      category: 'üéµ M√öSICA & ENTRETENIMENTO',
      userLimit: 12,
    },
    {
      name: 'üì∫ Watch Party',
      type: ChannelType.GuildVoice,
      category: 'üéµ M√öSICA & ENTRETENIMENTO',
      userLimit: 15,
    },
    {
      name: 'üé¨ Cinema',
      type: ChannelType.GuildVoice,
      category: 'üéµ M√öSICA & ENTRETENIMENTO',
      userLimit: 10,
    },

    // Voice channels - Games & Activities
    {
      name: 'üé≤ Outros Jogos',
      type: ChannelType.GuildVoice,
      category: 'üé≤ JOGOS & ATIVIDADES',
      userLimit: 8,
    },
    {
      name: 'üÉè Jogos de Mesa',
      type: ChannelType.GuildVoice,
      category: 'üé≤ JOGOS & ATIVIDADES',
      userLimit: 6,
    },
    {
      name: 'üß† Quiz & Desafios',
      type: ChannelType.GuildVoice,
      category: 'üé≤ JOGOS & ATIVIDADES',
      userLimit: 10,
    },

    // Voice channels - Events
    {
      name: 'üèÜ Torneio Oficial',
      type: ChannelType.GuildVoice,
      category: 'üèÜ COMPETI√á√ïES & EVENTOS',
      userLimit: 20,
    },
    {
      name: 'üé™ Evento Especial',
      type: ChannelType.GuildVoice,
      category: 'üèÜ COMPETI√á√ïES & EVENTOS',
      userLimit: 15,
    },
    {
      name: 'üìπ Transmiss√£o',
      type: ChannelType.GuildVoice,
      category: 'üèÜ COMPETI√á√ïES & EVENTOS',
      userLimit: 5,
    },

    // Voice channels - Community
    {
      name: 'ü§ù Reuni√£o Staff',
      type: ChannelType.GuildVoice,
      category: 'ü§ù COMUNIDADE',
      userLimit: 8,
    },
    {
      name: 'üí° Brainstorm',
      type: ChannelType.GuildVoice,
      category: 'ü§ù COMUNIDADE',
      userLimit: 6,
    },
    {
      name: 'üÜò Suporte Voz',
      type: ChannelType.GuildVoice,
      category: 'ü§ù COMUNIDADE',
      userLimit: 4,
    },
  ];

  // Choose which channels to create based on mode
  const channels = mode === 'essential' ? essentialChannels : allChannels;
  const categories = new Map<string, any>();

  // Create categories first
  for (const channelData of channels.filter(c => c.type === ChannelType.GuildCategory)) {
    try {
      const existingCategory = guild.channels.cache.find(
        (c: any) => c.name === channelData.name && c.type === ChannelType.GuildCategory,
      );

      if (!existingCategory) {
        const category = await guild.channels.create({
          name: channelData.name,
          type: ChannelType.GuildCategory,
        });
        categories.set(channelData.name, category);
        created++;
      } else {
        categories.set(channelData.name, existingCategory);
        updated++;
      }
    } catch (error) {
      logger.error(`Error creating category ${channelData.name}:`, error);
    }
  }

  // Create other channels
  for (const channelData of channels.filter(c => c.type !== ChannelType.GuildCategory)) {
    try {
      const existingChannel = guild.channels.cache.find((c: any) => c.name === channelData.name);

      if (!existingChannel) {
        const parent = channelData.category ? categories.get(channelData.category) : null;

        const channelOptions: any = {
          name: channelData.name,
          type: channelData.type,
          parent: parent?.id,
        };

        // Add topic for text channels
        if (channelData.topic) {
          channelOptions.topic = channelData.topic;
        }

        // Add user limit for voice channels
        if (channelData.userLimit && channelData.type === ChannelType.GuildVoice) {
          channelOptions.userLimit = channelData.userLimit;
        }

        await guild.channels.create(channelOptions);
        created++;
      } else {
        updated++;
      }
    } catch (error) {
      logger.error(`Error creating channel ${channelData.name}:`, error);
    }
  }

  return `üì∫ **Canais**: ${created} criados, ${updated} atualizados`;
}

/**
 * Setup database configuration
 */
async function setupDatabase(guild: Guild, client: ExtendedClient): Promise<string> {
  try {
    const logsChannel = guild.channels.cache.find((c: any) => c.name === 'üìù-logs');

    const guildConfig = await client.database.client.guildConfig.upsert({
      where: { guildId: guild.id },
      update: {
        config: JSON.stringify({
          isSetup: true,
          welcomeChannelId: guild.channels.cache.find((c: any) => c.name === 'üëã-boas-vindas')?.id,
          logsChannelId: logsChannel?.id,
          musicChannelId: guild.channels.cache.find((c: any) => c.name === 'üéµ-m√∫sica')?.id,
          rankingChannelId: guild.channels.cache.find((c: any) => c.name === 'üìä-rankings')?.id,
          clipsChannelId: guild.channels.cache.find((c: any) => c.name === 'üé¨-clips')?.id,
          autoRoleEnabled: true,
          welcomeMessageEnabled: true,
          rankingNotificationsEnabled: true,
          badgeNotificationsEnabled: true,
        }),
      },
      create: {
        guildId: guild.id,
        config: JSON.stringify({
          isSetup: true,
          welcomeChannelId: guild.channels.cache.find((c: any) => c.name === 'üëã-boas-vindas')?.id,
          logsChannelId: logsChannel?.id,
          musicChannelId: guild.channels.cache.find((c: any) => c.name === 'üéµ-m√∫sica')?.id,
          rankingChannelId: guild.channels.cache.find((c: any) => c.name === 'üìä-rankings')?.id,
          clipsChannelId: guild.channels.cache.find((c: any) => c.name === 'üé¨-clips')?.id,
          autoRoleEnabled: true,
          welcomeMessageEnabled: true,
          rankingNotificationsEnabled: true,
          badgeNotificationsEnabled: true,
        }),
      },
    });

    // Create guild entry
    await client.database.guilds.upsert({
      id: guild.id,
      name: guild.name,
      ownerId: guild.ownerId,
    });

    // Configure logging service automatically
    if (logsChannel && client.services?.logging) {
      try {
        await client.services.logging.updateGuildConfig(guild.id, {
          channels: {
            moderation: logsChannel.id,
          },
          events: {
            messageDelete: true,
            messageEdit: true,
            memberJoin: true,
            memberLeave: true,
            memberUpdate: true,
            memberBan: true,
            memberUnban: true,
            roleCreate: true,
            roleDelete: true,
            roleUpdate: true,
            channelCreate: true,
            channelDelete: true,
            channelUpdate: true,
            voiceJoin: true,
            voiceLeave: true,
            voiceMove: true,
            inviteCreate: true,
            inviteDelete: true,
            moderationActions: true,
          },
        });

        // Send confirmation message to logs channel
        const confirmEmbed = new EmbedBuilder()
          .setTitle('‚úÖ Sistema de Logs Configurado')
          .setDescription(
            'O sistema de logs foi configurado automaticamente durante o bootstrap do servidor.',
          )
          .addFields(
            { name: 'üìù Canal de Logs', value: `<#${logsChannel.id}>`, inline: true },
            { name: 'üé´ Logs de Tickets', value: 'Ativados', inline: true },
            { name: 'üë• Logs de Membros', value: 'Ativados', inline: true },
            { name: 'üí¨ Logs de Mensagens', value: 'Ativados', inline: true },
            { name: 'üîß Logs de Modera√ß√£o', value: 'Ativados', inline: true },
            { name: '‚öôÔ∏è Logs de Servidor', value: 'Ativados', inline: true },
          )
          .setColor(0x00ff00 as ColorResolvable)
          .setFooter({ text: 'Use /logs status para verificar a configura√ß√£o' })
          .setTimestamp();

        if (logsChannel instanceof TextChannel) {
          await logsChannel.send({ embeds: [confirmEmbed] });
        }
      } catch (logError) {
        console.error('Error configuring logging service:', logError);
      }
    }

    // Configure persistent ticket system automatically
    const abrirTicketChannel = guild.channels.cache.find((c: any) => c.name === 'üéüÔ∏è-abrir-ticket');
    const logsTicketChannel = guild.channels.cache.find((c: any) => c.name === 'üé´-logs-ticket');
    const ticketCategory = guild.channels.cache.find(
      (c: any) => c.name === 'üé´ TICKETS' && c.type === ChannelType.GuildCategory,
    );
    const supportRole = guild.roles.cache.find(
      (r: any) =>
        r.name.includes('Moderador') || r.name.includes('Staff') || r.name.includes('Admin'),
    );

    if (abrirTicketChannel && (client as any).persistentTicketService) {
      try {
        // Configure persistent ticket system
        const success = await (client as any).persistentTicketService.configureGuild(
          guild.id,
          abrirTicketChannel.id,
          {
            categoryId: ticketCategory?.id,
            supportRoleId: supportRole?.id,
            logChannelId: logsTicketChannel?.id,
            maxTicketsPerUser: 3,
            autoClose: true,
            autoCloseHours: 48,
          },
        );

        if (success && logsTicketChannel) {
          // Send confirmation message to logs channel
          const ticketConfirmEmbed = new EmbedBuilder()
            .setTitle('üé´ Sistema de Tickets Persistente Configurado')
            .setDescription(
              'O sistema de tickets persistente foi configurado automaticamente durante o bootstrap do servidor.',
            )
            .addFields(
              { name: 'üéüÔ∏è Canal P√∫blico', value: `<#${abrirTicketChannel.id}>`, inline: true },
              { name: 'üìã Canal de Logs', value: `<#${logsTicketChannel.id}>`, inline: true },
              {
                name: 'üìÅ Categoria',
                value: ticketCategory ? `<#${ticketCategory.id}>` : 'Ser√° criada automaticamente',
                inline: true,
              },
              {
                name: 'üë• Cargo de Suporte',
                value: supportRole ? `<@&${supportRole.id}>` : 'N√£o configurado',
                inline: true,
              },
              { name: 'üìä Max Tickets/Usu√°rio', value: '3', inline: true },
              { name: '‚è∞ Fechamento Autom√°tico', value: '48 horas de inatividade', inline: true },
            )
            .setColor(0x0099ff as ColorResolvable)
            .setFooter({ text: 'Embed fixo criado no canal p√∫blico para abertura de tickets' })
            .setTimestamp();

          if (logsTicketChannel instanceof TextChannel) {
            await logsTicketChannel.send({ embeds: [ticketConfirmEmbed] });
          }
        }
      } catch (ticketError) {
        console.error('Error configuring persistent ticket service:', ticketError);
      }
    }

    return 'üíæ **Banco de dados**: Configurado com sucesso (+ Logs + Tickets)';
  } catch (error) {
    return 'üíæ **Banco de dados**: Erro na configura√ß√£o';
  }
}

/**
 * Setup channel permissions
 */
async function setupPermissions(guild: Guild): Promise<string> {
  const logger = new Logger();
  let configured = 0;

  try {
    const everyoneRole = guild.roles.everyone;
    const verificadoRole = guild.roles.cache.find(r => r.name === '‚úÖ Verificado');

    // Configure admin channels permissions
    const adminChannels = guild.channels.cache.filter(
      c => c.name.includes('admin') || c.name.includes('logs') || c.name.includes('tickets'),
    );

    for (const channel of Array.from(adminChannels.values())) {
      if ('permissionOverwrites' in channel) {
        await channel.permissionOverwrites.edit(everyoneRole, {
          ViewChannel: false,
        });
        configured++;
      }
    }

    // Configure verification requirement for main channels
    if (verificadoRole) {
      const mainChannels = guild.channels.cache.filter(
        c =>
          !c.name.includes('admin') &&
          !c.name.includes('logs') &&
          !c.name.includes('boas-vindas') &&
          c.type !== ChannelType.GuildCategory,
      );

      for (const channel of Array.from(mainChannels.values())) {
        if ('permissionOverwrites' in channel) {
          await channel.permissionOverwrites.edit(everyoneRole, {
            SendMessages: false,
            Connect: false,
          });

          await channel.permissionOverwrites.edit(verificadoRole, {
            SendMessages: true,
            Connect: true,
          });
          configured++;
        }
      }
    }

    return `üîí **Permiss√µes**: ${configured} canais configurados`;
  } catch (error) {
    logger.error('Error setting up permissions:', error);
    return 'üîí **Permiss√µes**: Erro na configura√ß√£o';
  }
}

/**
 * Setup automatic reactions
 */
async function setupAutomaticReactions(guild: Guild): Promise<void> {
  // Add automatic reactions to welcome and rules messages
  const welcomeChannel = guild.channels.cache.find(c => c.name === 'üëã-boas-vindas') as TextChannel;
  const rulesChannel = guild.channels.cache.find(c => c.name === 'üìú-regras') as TextChannel;

  if (welcomeChannel) {
    const messages = await welcomeChannel.messages.fetch({ limit: 10 });
    const latestMessages = messages.first(3);

    for (const message of latestMessages) {
      if (message.author.bot && message.embeds.length > 0) {
        await message.react('ü¶Ö');
        await message.react('üéÆ');
        await message.react('üèÜ');
        await message.react('‚ù§Ô∏è');
      }
    }
  }

  if (rulesChannel) {
    const messages = await rulesChannel.messages.fetch({ limit: 10 });
    const ruleMessages = messages.filter((m: any) => m.author.bot && m.embeds.length > 0);

    for (const message of Array.from(ruleMessages.values())) {
      await message.react('‚úÖ'); // Accept rules
      await message.react('üìã'); // Read rules
    }
  }
}

/**
 * Setup interactive elements
 */
async function setupInteractiveElements(guild: Guild): Promise<void> {
  const commandsChannel = guild.channels.cache.find(c => c.name === 'ü§ñ-comandos') as TextChannel;

  if (commandsChannel) {
    // Create interactive command guide
    const commandGuideEmbed = new EmbedBuilder()
      .setTitle('ü§ñ Guia Interativo de Comandos')
      .setDescription(
        `
        ### üéÆ **Comandos Principais do Hawk Esports**
        
        Clique nas rea√ß√µes abaixo para ver os comandos de cada categoria!
      `,
      )
      .addFields(
        {
          name: 'üéØ PUBG & Stats',
          value: '`/stats` `/ranking` `/register`\n`/scrim` `/squad` `/match`',
          inline: true,
        },
        {
          name: 'üéµ M√∫sica',
          value: '`/play` `/skip` `/queue`\n`/volume` `/pause` `/resume`',
          inline: true,
        },
        {
          name: 'üé≤ Divers√£o',
          value: '`/quiz` `/game` `/challenge`\n`/badge` `/daily` `/profile`',
          inline: true,
        },
        {
          name: 'üõ†Ô∏è Utilidades',
          value: '`/help` `/ping` `/server`\n`/user` `/avatar` `/invite`',
          inline: true,
        },
        {
          name: 'üèÜ Competitivo',
          value: '`/tournament` `/team` `/scrim`\n`/analyze` `/coach` `/review`',
          inline: true,
        },
        {
          name: 'üé® Personaliza√ß√£o',
          value: '`/color` `/nickname` `/status`\n`/theme` `/banner` `/signature`',
          inline: true,
        },
      )
      .setColor(0x7289da)
      .setFooter({ text: 'Use /help [comando] para detalhes espec√≠ficos!' })
      .setTimestamp();

    const commandMessage = await commandsChannel.send({ embeds: [commandGuideEmbed] });

    // Add reaction roles for command categories
    await commandMessage.react('üéØ'); // PUBG commands
    await commandMessage.react('üéµ'); // Music commands
    await commandMessage.react('üé≤'); // Fun commands
    await commandMessage.react('üõ†Ô∏è'); // Utility commands
    await commandMessage.react('üèÜ'); // Competitive commands
    await commandMessage.react('üé®'); // Customization commands
  }

  // Setup role selection in appropriate channel
  const communityChannel = guild.channels.cache.find(c => c.name === 'üí¨-geral') as TextChannel;

  if (communityChannel) {
    const roleSelectionEmbed = new EmbedBuilder()
      .setTitle('üé≠ Sele√ß√£o de Cargos')
      .setDescription(
        `
        ### üîî **Escolha suas notifica√ß√µes:**
        
        Reaja com os emojis abaixo para receber notifica√ß√µes sobre:
      `,
      )
      .addFields(
        { name: 'üèÜ Torneios', value: 'Seja notificado sobre competi√ß√µes oficiais', inline: true },
        { name: 'üéâ Eventos', value: 'Receba avisos sobre eventos especiais', inline: true },
        { name: 'üéµ M√∫sica', value: 'Notifica√ß√µes sobre sess√µes musicais', inline: true },
        { name: 'üé¨ Streams', value: 'Avisos quando membros est√£o fazendo live', inline: true },
        { name: 'üì¢ An√∫ncios', value: 'Atualiza√ß√µes importantes do servidor', inline: true },
        { name: 'üéÆ Partidas', value: 'Convites para jogos e scrimmages', inline: true },
      )
      .setColor(0x00ae86)
      .setFooter({ text: 'Voc√™ pode alterar suas escolhas a qualquer momento!' });

    const roleMessage = await communityChannel.send({ embeds: [roleSelectionEmbed] });

    // Add reactions for role selection
    await roleMessage.react('üèÜ');
    await roleMessage.react('üéâ');
    await roleMessage.react('üéµ');
    await roleMessage.react('üé¨');
    await roleMessage.react('üì¢');
    await roleMessage.react('üéÆ');
  }

  // Setup persistent ticket system
  const ticketChannel = guild.channels.cache.find(c => c.name === 'üéüÔ∏è-abrir-ticket') as TextChannel;
  const ticketCategory = guild.channels.cache.find(c => c.name === 'üé´ TICKETS') as CategoryChannel;
  const supportRole = guild.roles.cache.find(
    r => r.name === 'üéØ Helper' || r.name === '‚öîÔ∏è Moderador' || r.name === 'üõ°Ô∏è Admin',
  );
  const logChannel = guild.channels.cache.find(c => c.name === 'üé´-logs-ticket') as TextChannel;

  if (ticketChannel && ticketCategory) {
    try {
      // Import PersistentTicketService dynamically to avoid circular dependencies
      const { PersistentTicketService } = await import('../../services/persistent-ticket.service');
      const persistentTicketService = new PersistentTicketService(guild.client as any);

      // Configure persistent tickets
      await persistentTicketService.configureGuild(guild.id, ticketChannel.id, {
        categoryId: ticketCategory.id,
        supportRoleId: supportRole?.id,
        logChannelId: logChannel?.id,
        maxTicketsPerUser: 3,
        autoClose: true,
        autoCloseHours: 48,
      });

      // Initialize the embed
      await persistentTicketService.initializeEmbed(guild.id);

      console.log('‚úÖ Sistema de tickets persistente configurado automaticamente');
    } catch (error) {
      console.error('‚ùå Erro ao configurar sistema de tickets persistente:', error);
    }
  }
}

/**
 * Setup welcome messages
 */
async function setupWelcomeMessages(guild: Guild): Promise<string> {
  try {
    const welcomeChannel = guild.channels.cache.find(
      c => c.name === 'üëã-boas-vindas',
    ) as TextChannel;
    const rulesChannel = guild.channels.cache.find(c => c.name === 'üìú-regras') as TextChannel;
    const commandsChannel = guild.channels.cache.find(c => c.name === 'ü§ñ-comandos') as TextChannel;

    if (welcomeChannel) {
      // Main Welcome Embed
      const welcomeEmbed = new EmbedBuilder()
        .setTitle('ü¶Ö Bem-vindo ao Hawk Esports!')
        .setDescription(
          `
          ### üéâ **Seja muito bem-vindo(a) √† nossa comunidade!**
          
          Voc√™ acabou de entrar no **servidor Discord mais completo** para jogadores de PUBG! 
          Aqui temos tudo que voc√™ precisa para elevar seu jogo ao pr√≥ximo n√≠vel.
        `,
        )
        .setColor(0x00d4aa)
        .setThumbnail(guild.iconURL({ size: 256 }))
        .setFooter({
          text: 'ü¶Ö Hawk Esports - Dominando os Battlegrounds desde 2024',
          iconURL: guild.iconURL() || undefined,
        })
        .setTimestamp();

      // Features Embed
      const featuresEmbed = new EmbedBuilder()
        .setTitle('üåü O que voc√™ encontrar√° aqui:')
        .addFields(
          {
            name: 'üéÆ PUBG Competitivo',
            value:
              '‚Ä¢ Rankings oficiais\n‚Ä¢ Scrimmages di√°rias\n‚Ä¢ An√°lises t√°ticas\n‚Ä¢ Treinos em equipe',
            inline: true,
          },
          {
            name: 'üèÜ Torneios & Eventos',
            value:
              '‚Ä¢ Competi√ß√µes semanais\n‚Ä¢ Pr√™mios incr√≠veis\n‚Ä¢ Hall da Fama\n‚Ä¢ Eventos especiais',
            inline: true,
          },
          {
            name: 'üéµ Entretenimento',
            value: '‚Ä¢ Bot de m√∫sica premium\n‚Ä¢ Watch parties\n‚Ä¢ Karaok√™\n‚Ä¢ Cinema comunit√°rio',
            inline: true,
          },
          {
            name: 'üéØ Atividades',
            value: '‚Ä¢ Mini-games √∫nicos\n‚Ä¢ Quizzes PUBG\n‚Ä¢ Desafios di√°rios\n‚Ä¢ Sistema de badges',
            inline: true,
          },
          {
            name: 'üé¨ Conte√∫do',
            value:
              '‚Ä¢ Compartilhe clips\n‚Ä¢ Rankings de highlights\n‚Ä¢ Suporte a streamers\n‚Ä¢ Arte da comunidade',
            inline: true,
          },
          {
            name: 'ü§ù Comunidade',
            value: '‚Ä¢ Suporte 24/7\n‚Ä¢ Parcerias\n‚Ä¢ Feedback ativo\n‚Ä¢ Ambiente acolhedor',
            inline: true,
          },
        )
        .setColor(0xff6b35)
        .setFooter({ text: 'Explore todos os canais e descubra ainda mais!' });

      // Quick Start Embed
      const quickStartEmbed = new EmbedBuilder()
        .setTitle('üöÄ Primeiros Passos')
        .setDescription(
          `
          ### Para come√ßar sua jornada:
          
          **1.** üìú Leia as regras em <#${rulesChannel?.id}>
          **2.** ü§ñ Teste comandos em <#${commandsChannel?.id}>
          **3.** üéÆ Escolha seus cargos de notifica√ß√£o
          **4.** üë• Encontre uma squad em <#${guild.channels.cache.find(c => c.name === 'üë•-procurar-squad')?.id}>
          **5.** üéâ Participe dos eventos e se divirta!
          
          ### üéÅ **B√¥nus de Boas-vindas:**
          ‚Ä¢ **50 XP** para come√ßar
          ‚Ä¢ Acesso a **canais VIP** por 7 dias
          ‚Ä¢ **Badge especial** de novo membro
        `,
        )
        .setColor(0x00ae86)
        .setFooter({ text: 'D√∫vidas? Use /help ou pergunte no suporte!' });

      await welcomeChannel.send({ embeds: [welcomeEmbed, featuresEmbed, quickStartEmbed] });
    }

    if (rulesChannel) {
      // Main Rules Embed
      const rulesEmbed = new EmbedBuilder()
        .setTitle('üìú Regras Oficiais do Servidor')
        .setDescription(
          `
          ### üõ°Ô∏è **Para manter nossa comunidade incr√≠vel, siga estas diretrizes:**
          
          *Ao permanecer no servidor, voc√™ automaticamente concorda com todas as regras abaixo.*
        `,
        )
        .setColor(0xe74c3c)
        .setThumbnail(guild.iconURL())
        .setFooter({ text: 'Regras atualizadas em ' + new Date().toLocaleDateString('pt-BR') });

      // Respect Rules
      const respectEmbed = new EmbedBuilder()
        .setTitle('ü§ù Respeito e Conviv√™ncia')
        .addFields(
          {
            name: '‚úÖ Permitido',
            value:
              '‚Ä¢ Tratamento respeitoso\n‚Ä¢ Discuss√µes construtivas\n‚Ä¢ Ajudar outros membros\n‚Ä¢ Diversidade de opini√µes',
            inline: true,
          },
          {
            name: '‚ùå Proibido',
            value:
              '‚Ä¢ Discrimina√ß√£o/Preconceito\n‚Ä¢ Ass√©dio ou bullying\n‚Ä¢ Ataques pessoais\n‚Ä¢ Comportamento t√≥xico',
            inline: true,
          },
          {
            name: '‚öñÔ∏è Consequ√™ncia',
            value: '**Advert√™ncia ‚Üí Mute ‚Üí Ban**\n\nToxicidade n√£o ser√° tolerada!',
            inline: true,
          },
        )
        .setColor(0x2ecc71);

      // Communication Rules
      const communicationEmbed = new EmbedBuilder()
        .setTitle('üí¨ Comunica√ß√£o e Canais')
        .addFields(
          {
            name: 'üìç Use o canal correto',
            value:
              '‚Ä¢ PUBG ‚Üí Canais PUBG\n‚Ä¢ M√∫sica ‚Üí Canais de m√∫sica\n‚Ä¢ Comandos ‚Üí #ü§ñ-comandos\n‚Ä¢ Suporte ‚Üí #üÜò-suporte',
            inline: false,
          },
          {
            name: 'üö´ Evite',
            value:
              '‚Ä¢ Spam ou flood\n‚Ä¢ CAPS LOCK excessivo\n‚Ä¢ Mensagens repetitivas\n‚Ä¢ Off-topic em canais espec√≠ficos',
            inline: true,
          },
          {
            name: 'üí° Dicas',
            value:
              '‚Ä¢ Use threads para discuss√µes longas\n‚Ä¢ Reaja em vez de comentar\n‚Ä¢ Seja claro e objetivo\n‚Ä¢ Use spoilers quando necess√°rio',
            inline: true,
          },
        )
        .setColor(0x3498db);

      // Gaming Rules
      const gamingEmbed = new EmbedBuilder()
        .setTitle('üéÆ Jogos e Competi√ß√µes')
        .addFields(
          {
            name: 'üèÜ Fair Play',
            value:
              '‚Ä¢ Jogue limpo sempre\n‚Ä¢ Sem cheats ou exploits\n‚Ä¢ Respeite advers√°rios\n‚Ä¢ Aceite derrotas com dignidade',
            inline: true,
          },
          {
            name: 'üéØ Competi√ß√µes',
            value:
              '‚Ä¢ Siga regras espec√≠ficas\n‚Ä¢ Chegue no hor√°rio\n‚Ä¢ Comunique problemas\n‚Ä¢ Mantenha esp√≠rito esportivo',
            inline: true,
          },
          {
            name: '‚ö†Ô∏è Puni√ß√µes',
            value: '**Trapa√ßa = Ban imediato**\n\nTorneios t√™m regras pr√≥prias!',
            inline: true,
          },
        )
        .setColor(0x9b59b6);

      // Content Rules
      const contentEmbed = new EmbedBuilder()
        .setTitle('üîí Conte√∫do e M√≠dia')
        .addFields(
          {
            name: '‚úÖ Compartilhe',
            value:
              '‚Ä¢ Clips √©picos de PUBG\n‚Ä¢ Arte da comunidade\n‚Ä¢ Memes apropriados\n‚Ä¢ Conte√∫do educativo',
            inline: true,
          },
          {
            name: '‚ùå N√£o compartilhe',
            value:
              '‚Ä¢ Conte√∫do NSFW\n‚Ä¢ Material com direitos autorais\n‚Ä¢ Links suspeitos\n‚Ä¢ Conte√∫do ofensivo',
            inline: true,
          },
          {
            name: 'üì± Redes Sociais',
            value: `Divulga√ß√£o permitida em:\n<#${guild.channels.cache.find(c => c.name === 'üì¢-divulga√ß√£o')?.id}>`,
            inline: true,
          },
        )
        .setColor(0xf39c12);

      // Punishment System
      const punishmentEmbed = new EmbedBuilder()
        .setTitle('‚öñÔ∏è Sistema de Puni√ß√µes')
        .setDescription(
          `
          ### üìä **N√≠veis de Puni√ß√£o:**
          
          **üü° N√≠vel 1 - Advert√™ncia**
          ‚Ä¢ Primeira infra√ß√£o leve
          ‚Ä¢ Aviso p√∫blico ou privado
          ‚Ä¢ Registro no sistema
          
          **üü† N√≠vel 2 - Mute Tempor√°rio**
          ‚Ä¢ Reincid√™ncia ou infra√ß√£o m√©dia
          ‚Ä¢ 1h a 24h sem poder falar
          ‚Ä¢ Revis√£o do comportamento
          
          **üî¥ N√≠vel 3 - Ban Tempor√°rio**
          ‚Ä¢ Infra√ß√µes graves ou repetidas
          ‚Ä¢ 1 dia a 1 semana fora do servidor
          ‚Ä¢ Chance de recurso
          
          **‚ö´ N√≠vel 4 - Ban Permanente**
          ‚Ä¢ Infra√ß√µes muito graves
          ‚Ä¢ Comportamento inaceit√°vel
          ‚Ä¢ Sem direito a recurso
          
          ### üõ°Ô∏è **A staff se reserva o direito de aplicar puni√ß√µes conforme a gravidade da situa√ß√£o.**
        `,
        )
        .setColor(0xe74c3c)
        .setFooter({ text: 'D√∫vidas sobre puni√ß√µes? Contate a administra√ß√£o.' });

      await rulesChannel.send({
        embeds: [
          rulesEmbed,
          respectEmbed,
          communicationEmbed,
          gamingEmbed,
          contentEmbed,
          punishmentEmbed,
        ],
      });
    }

    return 'üí¨ **Mensagens**: Enviadas com sucesso';
  } catch (error) {
    return 'üí¨ **Mensagens**: Erro no envio';
  }
}

/**
 * Setup final touches and interactive features
 */
async function setupFinalTouches(guild: Guild): Promise<string> {
  const logger = new Logger();
  let features = 0;

  try {
    // Setup server boost tracking
    const boostChannel = guild.channels.cache.find(c => c.name === 'üì¢-an√∫ncios') as TextChannel;
    if (boostChannel) {
      const boostEmbed = new EmbedBuilder()
        .setTitle('üíé Sistema de Boost Ativo!')
        .setDescription(
          'Obrigado por apoiar nosso servidor! Boosts nos ajudam a manter recursos premium.',
        )
        .setColor(0xff73fa)
        .addFields(
          {
            name: 'üéÅ Benef√≠cios do Boost',
            value:
              '‚Ä¢ Qualidade de √°udio superior\n‚Ä¢ Mais emojis personalizados\n‚Ä¢ Banner do servidor\n‚Ä¢ Vanity URL personalizada',
            inline: true,
          },
          {
            name: 'üèÜ Recompensas',
            value:
              '‚Ä¢ Cargo especial de Booster\n‚Ä¢ Acesso a canais VIP\n‚Ä¢ Prioridade em eventos\n‚Ä¢ Badge exclusivo',
            inline: true,
          },
        )
        .setFooter({ text: 'Cada boost faz a diferen√ßa! üíú' });

      await boostChannel.send({ embeds: [boostEmbed] });
      features++;
    }

    // Setup activity tracking
    const activityChannel = guild.channels.cache.find(
      c => c.name === 'üìä-rankings-geral',
    ) as TextChannel;
    if (activityChannel) {
      const activityEmbed = new EmbedBuilder()
        .setTitle('üìä Sistema de Atividade')
        .setDescription('Ganhe XP participando da comunidade e suba nos rankings!')
        .setColor(0x00d4aa)
        .addFields(
          {
            name: 'üí¨ Como ganhar XP',
            value:
              '‚Ä¢ Enviar mensagens (+1-3 XP)\n‚Ä¢ Participar de voice (+5 XP/min)\n‚Ä¢ Reagir a mensagens (+1 XP)\n‚Ä¢ Completar desafios (+10-50 XP)',
            inline: true,
          },
          {
            name: 'üèÜ Recompensas',
            value:
              '‚Ä¢ Cargos de n√≠vel\n‚Ä¢ Acesso a recursos especiais\n‚Ä¢ Badges exclusivos\n‚Ä¢ Pr√™mios mensais',
            inline: true,
          },
        )
        .setFooter({ text: 'Use /rank para ver seu progresso!' });

      await activityChannel.send({ embeds: [activityEmbed] });
      features++;
    }

    return `‚ö° **Recursos**: ${features} sistemas ativados`;
  } catch (error) {
    logger.error('Error setting up final touches:', error);
    return '‚ö° **Recursos**: Erro na ativa√ß√£o';
  }
}

export default bootstrap;
